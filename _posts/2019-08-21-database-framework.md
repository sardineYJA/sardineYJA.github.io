---
layout: post
title: "数据库架构知识"
date: 2019-08-21
description: "简单介绍数据库架构知识"
tag: 数据库

---


## 关系

一对一关系的表现有两种：一种是外键关联；一种是主键关联（将信息分开如：常用/不常用，减少查询时间）。

一对多关系处理：一对多的两个实体间，在“多”的实体表中新增“少”的主键。

多对多关联关系一般需采用中间表（关系表）的方式处理，将多对多转化为两个一对多，即将两个表的主键放到中间表。


## 分库分表

分库：把存于一个库的数据分散到多个库中

分表：把存于一个表的数据分散到多个表中


# 单Key数据库无限容量

## 垂直拆分

垂直拆分是指，将一个属性较多，一行数据较大的表，将不同的属性拆分到不同的表中，以降低单库（表）大小，达到提升性能的目的的方法，垂直切分后，各个库（表）的特点是：

1. 每个库（表）的结构都不一样

2. 一般来说，每个库（表）的属性至少有一列交集，一般是主键

3. 所有库（表）的并集是全量数据

垂直拆分依据主要有几点：

1. 将长度较短，访问频率较高的属性尽量放在一个表里，这个表暂且称为主表

2. 将字段较长，访问频率较低的属性尽量放在一个表里，这个表暂且称为扩展表

3. 经常一起访问的属性，也可以放在一个表里。优先考虑1和2，第3点不是必须

## 水平拆分

水平切分是指，以某个字段为依据（例如uid），按照一定规则（例如取模），将一个库（表）上的数据拆分到多个库（表）上，以降低单库（表）大小，达到提升性能的目的的方法，水平切分后，各个库（表）的特点是：

1. 每个库（表）的结构都一样

2. 每个库（表）的数据都不一样，没有交集

3. 所有库（表）的并集是全量数据


水平切分，到底是分库还是分表？

1. 强烈建议分库，而不是分表，因为：

2. 分表依然公用一个数据库文件，仍然有磁盘IO的竞争

3. 分库能够很容易的将数据迁移到不同数据库实例，甚至数据库机器上，扩展性更好

水平切分的方法：

1. 范围法：策略简单，扩容简单，但是数据量不均，请求量不均

2. 哈希法：策略简单，数据量和请求量均衡，但是扩容麻烦

水平切分后的问题：

根据uid属性分库后，非uid属性的查询如何进行（如name如何直接定位到库）？

答：建立非uid属性到uid的映射关系，根据uid定位到库


# 一对多数据库无限容量




# 多对多数据库无限容量

### 应用场景：

相互关注为强好友关系，单方面关注为弱好友关系，此时都为多对多关系。

讨论强好友关系实现：

第一种情况：表friend(uid1, uid2)

第二种情况：表guanzhu(uid, guanzhu_uid) , 表fensi(uid, fensi_uid)

### 问题：

第一种 friend表，数据量大时，如果使用uid1来分库，那么uid2上的查询就需要遍历多库；

第二种 通过数据冗余来实现多对多关系水平切分，两个表都使用uid来分库，均只需要进行一次查询，就能找到对应的关注与粉丝，而不需要多个库扫描。

## 数据冗余实现方案

1. 服务同步冗余

优点：服务器对两数据库进行写，单次写变两次写，不复杂，数据一致性相对较高（双写成功才返回）

缺点：请求处理时间增加了一倍（写两次）

2. 服务异步冗余

优点：服务先插入T1数据，服务向消息总线发送一个异步消息（发出即可，不用等返回，通常很快就能完成），T2开始写，请求处理时间短（写一次）

缺点：统的复杂性增加了，多引入了一个组件（消息总线）和一个服务（专用的数据复制服务），T1,T2之间有一个不一致时间段

3. 线下异步冗余

优点：请求处理时间短（写一次，线下由log写T2）

缺点：T1,T2之间有一个不一致时间段，数据的一致性依赖于线下服务的可靠性


# 参考

1. https://mp.weixin.qq.com/s/ad4tpM6cdi9r6vgfbaTzxg



