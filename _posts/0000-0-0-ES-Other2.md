---
layout: post
title: "ES 知识点补充"
date: 2020-05-06
description: "Elasticsearch"
tag: Elasticsearch

---

# 集群searchguard权限和x-path监控

## ES

参考 searchguard 安装 

安装：`bin/elasticsearch-plugin install file:///home/out/x-pack-6.1.1.zip`

elasticsearch.yml

```sh
xpack.monitoring.enabled: true
xpack.security.enabled: false   
xpack.graph.enabled: false
xpack.ml.enabled: false
xpack.watcher.enabled: false
```

## Kibana

安装：`bin/kibana-plugin install file:///home/out/search-guard-kibana-plugin-6.1.1-8.zip`

安装：`bin/kibana-plugin install file:///home/out/x-pack-6.1.1.zip`

```sh
server.host: XXX.XXX.XXX.XXX
elasticsearch.url: "http://XXX.XXX.XXX.XXX:9200"
elasticsearch.username: "admin"
elasticsearch.password: "admin"

xpack.monitoring.enabled: true
xpack.security.enabled: false 
xpack.reporting.enabled: false 
searchguard.session.keepalive: true
```



## logstash

安装：`./bin/logstash-plugin install file:///home/out/x-pack-6.1.1.zip`

```sh
http.host: "XXX.XXX.XXX.XXX"
xpack.monitoring.enabled: true  
xpack.monitoring.elasticsearch.url: "http://XXX.XXX.XXX.XXX:9200"
xpack.monitoring.elasticsearch.username: "admin" 
xpack.monitoring.elasticsearch.password: "admin"
```


## filebeat

```sh
xpack.monitoring.enabled: true
xpack.monitoring.elasticsearch:
  hosts: [ "http://XXX.XXX.XXX.XXX:9200" ]
  username: "admin"
  password: "admin"
```



# ES 重要参数

## Important Elasticsearch configuration

- path.data and path.logs
- cluster.name
- node.name
- bootstrap.memory_lock
- network.host
- discovery.zen.ping.unicast.hosts
- discovery.zen.minimum_master_nodes
- JVM heap dump path

## Important System Configuration

- Set JVM heap size
- Disable swapping
- Increase file descriptors
- Ensure sufficient virtual memory
- Ensure sufficient threads



# 时间

## ELK 时间戳

filebeat 发送到 logstash ，自动生成 @timestamp，表示接受Event的时间戳，却是UTC时间（即比北京时间少8小时）。

elasticsearch 默认时间也是 UTC 时间，所以注意时间范围查询的now也是UTC。

如案例：发送时间9:00:00，则存储到ES的@timestamp为1:00:00，如对@timestamp进行时间范围查询，如前2h，则now-2h/h即可，无需转换时间（now-8h-2h/h，错误）。


## 符号

- gte : greater-than or equal to
- gt  : greater-than
- lte : less-than or equal to
- lt  : less-than


## 时间单位

- y   年   
- M   月
- w   星期  
- d   天
- h   小时  
- H   小时
- m   分钟  
- s   秒


## 时间范围查询

```sh
{
  "size": 0,      # 返回结果条数
  "_source": [],  # 每条结果返回的字段，null表示所有

  "query": {
    "bool": {
      "must": [
        {"range": {
          "@timestamp": {
            "gte": "2020-01-01T01:30:30.000Z",
            "lte": "2020-01-01T15:00:00.000Z"
             # 或者
             "gte": "now-60m/m",  # /m 表示对分钟 四舍五入
             "lte": "now/m"
          }
         }
        }
      ]
    }
  }
}
```

## 日期格式化范围查询(format)

```sh
{
    "query": {
        "range": {
            "your_ftime": {
                "gte": "1/1/2019",
                "lte": "2020",
                "format": "dd/MM/yyyy||yyyy"
            }
        }
    }
}
```

## 时区范围查询(time_zone)

```sh
{
    "query": {
        "range": {
            "post_date": {
                "gte": "2018-01-01 00:00:00",
                "lte": "now",
                "format": "yyyy-MM-dd hh:mm:ss",
                "time_zone": "+1:00"
            }
        }
    }
}
# ES中的日期类型必须按照UTC时间格式存储, 上述的2018-01-01 00:00:00将被转换为2017-12-31T23:00:00 UTC
# now是不受time_zone影响
```









